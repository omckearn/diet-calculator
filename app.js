/* Auto-generated from CSV.
   Health: direct from 'Health score' (0/1/2)
   Environment: direct from 'Environmental impact (New formula)' (no conversion)
*/

const DATA = [
  {
    "id": 1,
    "title": "Vegetables (fresh, frozen, or unsalted canned)",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 0.8
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 0.7
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 0,
        "env": 0.6
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 1,
        "env": 0.4
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 2,
    "title": "Beans, lentils, chickpeas, tofu",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 0.7
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 0.7
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.7
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 0.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 3,
    "title": "Fruit (fresh, frozen, or unsweetened canned).",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 0.7
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 0.6
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 0,
        "env": 0.5
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 1,
        "env": 0.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 4,
    "title": "Nuts and nut butters",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 1.5
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 1.1
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.8
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 0.2
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 5,
    "title": "Beef, pork, or lamb",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 7.9
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 2,
        "env": 5.7
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 3.6
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 3.5
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 6,
    "title": "Processed meats",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 6.5
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 1,
        "env": 4.5
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 0,
        "env": 3.4
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 3.0
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 7,
    "title": "Fish and shellfish",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 2.9
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 1,
        "env": 2.5
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 2,
        "env": 1.3
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 1.1
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 8,
    "title": "Fat-free or low-fat dairy products",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 2.4
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 2.2
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 2.1
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 1.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 9,
    "title": "Full-fat dairy products",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 2.4
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 2.2
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 2.1
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 1,
        "env": 1.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 10,
    "title": "Chicken, turkey, eggs",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 1.5
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 1.0
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.6
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 0.5
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 11,
    "title": "Restaurant meals (including pizza, fast food, and takeout)",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 0.3
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 1,
        "env": 0.2
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.2
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 0.2
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 12,
    "title": "Whole-grain bread, brown rice, whole-grain pasta, whole-grain breakfast cereal (cold/cooked)",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 0.8
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 0.6
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.5
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 0.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 13,
    "title": "White bread, white rice, white pasta, white potatoes",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 0.8
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 2,
        "env": 0.6
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.5
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 0.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 14,
    "title": "High-sugar drinks",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 0.5
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 1,
        "env": 0.4
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.4
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 0.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 15,
    "title": "Sweets and desserts",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 0.3
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 2,
        "env": 0.3
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.2
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 1,
        "env": 0.1
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 16,
    "title": "Beer, wine, liquor",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 1.5
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 1,
        "env": 1.4
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 0,
        "env": 1.3
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 1.0
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  }
];

const EXPLANATIONS = {
  1: "Non-starchy veggies add fiber and micronutrients with a lighter footprint.",
  2: "Plant proteins that boost nutrition with comparatively low impact.",
  3: "Fruit adds vitamins and fiber, especially when unsweetened.",
  4: "Healthy fats and protein, but portion size still matters.",
  5: "Red meats tend to score lower on health and environment.",
  6: "Processed meats are linked with higher health risks and higher impact.",
  7: "Seafood can be beneficial, with impact varying by frequency.",
  8: "Lower-fat dairy tends to score higher on health.",
  9: "Full-fat dairy is higher in saturated fat and calories.",
  10: "Lean animal proteins with moderate health and footprint scores.",
  11: "Restaurant meals often add sodium, fat, and larger portions.",
  12: "Whole grains generally score higher for health and satiety.",
  13: "Refined grains score lower than whole grains.",
  14: "Sugary drinks add calories without much nutrition.",
  15: "Desserts are treats that score lower for routine intake.",
  16: "Alcohol adds calories and can lower overall scores."
};

const OPTIONS_ORDER = [
  "Less than once per week",
  "Once per week",
  "2-4 times per week",
  "Nearly daily or daily",
  "Twice or more times per day"
];

// Spreadsheet scores are 0/1/2 per question.
const MAX_PER_Q = 2;
const Q_COUNT = DATA.length;
const MAX_TOTAL = Q_COUNT * MAX_PER_Q;

const state = {
  answers: {}
};

function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}

function colorClassFromScore(score) {
  // Color is based on 0/1/2 cells in the spreadsheet.
  // If env has a decimal, round to nearest and clamp into 0..2.
  const v = clamp(Math.round(Number(score)), 0, 2);
  if (v === 0) return "badge--red";
  if (v === 1) return "badge--yellow";
  return "badge--green";
}

function pctMarker(total) {
  return clamp((total / MAX_TOTAL) * 100, 0, 100);
}

function getOption(qid, optionKey) {
  const q = DATA.find(x => x.id === qid);
  return q.options.find(o => o.key === optionKey);
}

function computeTotals() {
  let health = 0;
  let env = 0;
  let answered = 0;

  for (const q of DATA) {
    const key = state.answers[q.id];
    if (!key) continue;

    answered += 1;
    const opt = getOption(q.id, key);

    health += Number(opt.health);
    env += Number(opt.env);
  }

  // Env total shown with one decimal.
  env = Math.round(env * 10) / 10;

  return { health, env, answered };
}

function render() {
  document.getElementById("questionCount").textContent = String(Q_COUNT);
  document.getElementById("maxTotalHealth").textContent = String(MAX_TOTAL);
  document.getElementById("maxTotalEnv").textContent = String(MAX_TOTAL);

  const root = document.getElementById("questionsRoot");
  root.innerHTML = "";

  for (const q of DATA) {
    const card = document.createElement("div");
    card.className = "qcard";

    const top = document.createElement("div");
    top.className = "qtop";

    const textBlock = document.createElement("div");
    textBlock.className = "qtext";

    const title = document.createElement("h3");
    title.className = "qtitle";
    title.textContent = `Q${q.id}. ${q.title}`;

    const desc = document.createElement("p");
    desc.className = "qdesc";
    desc.textContent = EXPLANATIONS[q.id] || "";

    const scores = document.createElement("div");
    scores.className = "qscores";

    const key = state.answers[q.id];
    if (!key) {
      const b = document.createElement("div");
      b.className = "badge badge--muted";
      b.textContent = "No selection";
      scores.appendChild(b);
    } else {
      const opt = getOption(q.id, key);

      const b1 = document.createElement("div");
      b1.className = `badge ${colorClassFromScore(opt.health)}`;
      b1.innerHTML = `<span class="badge__k">Health</span> <span>${Number(opt.health)}</span>`;
      scores.appendChild(b1);

      const b2 = document.createElement("div");
      b2.className = `badge ${colorClassFromScore(opt.env)}`;
      b2.innerHTML = `<span class="badge__k">Env</span> <span>${Number(opt.env).toFixed(1)}</span>`;
      scores.appendChild(b2);
    }

    textBlock.appendChild(title);
    textBlock.appendChild(desc);
    top.appendChild(textBlock);
    top.appendChild(scores);

    const choices = document.createElement("div");
    choices.className = "choices";

    for (const optKey of OPTIONS_ORDER) {
      const optData = q.options.find(o => o.key === optKey);
      const id = `q${q.id}__${optKey.replace(/\W+/g, "_")}`;

      const choice = document.createElement("div");
      choice.className = "choice";

      const input = document.createElement("input");
      input.type = "radio";
      input.name = `q${q.id}`;
      input.id = id;
      input.value = optKey;
      input.checked = state.answers[q.id] === optKey;

      input.addEventListener("change", () => {
        state.answers[q.id] = optKey;
        updateUI();
        render();
      });

      const label = document.createElement("label");
      label.htmlFor = id;
      label.textContent = optData.label;

      choice.appendChild(input);
      choice.appendChild(label);
      choices.appendChild(choice);
    }

    card.appendChild(top);
    card.appendChild(choices);
    root.appendChild(card);
  }

  updateUI();
}

function updateUI() {
  const totals = computeTotals();

  document.getElementById("totalHealth").textContent = String(totals.health);
  document.getElementById("totalEnv").textContent = totals.env.toFixed(1);
  document.getElementById("answeredCount").textContent = String(totals.answered);

  const healthPos = `${pctMarker(totals.health)}%`;
  const envPos = `${pctMarker(totals.env)}%`;
  const healthMarker = document.getElementById("healthMarker");
  const envMarker = document.getElementById("envMarker");
  const healthMarkerBottom = document.getElementById("healthMarkerBottom");
  const envMarkerBottom = document.getElementById("envMarkerBottom");

  if (healthMarker) healthMarker.style.left = healthPos;
  if (envMarker) envMarker.style.left = envPos;
  if (healthMarkerBottom) healthMarkerBottom.style.left = healthPos;
  if (envMarkerBottom) envMarkerBottom.style.left = envPos;

  renderAdviceIfComplete();
}

function qName(qid) {
  const q = DATA.find(x => x.id === qid);
  return `Q${qid} ${q.title}`;
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function renderAdviceIfComplete() {
  const totals = computeTotals();
  const intro = document.getElementById("adviceIntro");
  const box = document.getElementById("adviceContent");

  if (totals.answered !== Q_COUNT) {
    if (intro) intro.textContent = "";
    box.hidden = true;
    box.innerHTML = "";
    return;
  }

  const picked = (qid) => {
    const key = state.answers[qid];
    const opt = getOption(qid, key);
    return { key, opt };
  };

  const healthyRules = {
    1: (h) => h === 2,
    2: (h) => h === 1 || h === 2,
    3: (h) => h === 2,
    4: (h) => h === 2,
    5: (h) => h === 2,
    6: (h) => h === 2,
    7: (h) => h === 2,
    8: (h) => h === 2,
    9: (h) => h === 1,
    10: (h) => h === 2,
    11: (h) => h === 1,
    12: (h) => h === 2,
    13: (h) => h === 2,
    14: (h) => h === 2,
    15: (h) => h === 2,
    16: (h) => h === 2
  };

  const moreFoods = [1,2,3,4,7,8,10,12];
  const lessFoods = [5,6,9,11,13,14,15,16];

  const healthyList = [];
  const moreList = [];
  const lessList = [];

  for (const q of DATA) {
    const { key, opt } = picked(q.id);
    const h = Number(opt.health);

    if (healthyRules[q.id] && healthyRules[q.id](h)) {
      healthyList.push({
        id: q.id,
        text: `${qName(q.id)} (${h} point${h === 1 ? "" : "s"})`
      });
    }

    if (moreFoods.includes(q.id) && (h === 0 || h === 1)) {
      moreList.push({
        id: q.id,
        health: h,
        text: `${qName(q.id)} (${h} point${h === 1 ? "" : "s"})`
      });
    }

    if (lessFoods.includes(q.id)) {
      if (q.id === 6 && h === 0) {
        lessList.push({ id: q.id, text: `${qName(q.id)} (0 points)` });
      } else if (q.id === 9) {
        if (key === "Nearly daily or daily" || key === "Twice or more times per day") {
          lessList.push({ id: q.id, text: `${qName(q.id)} (${key})` });
        }
      } else {
        if (h === 0) {
          lessList.push({ id: q.id, text: `${qName(q.id)} (0 points)` });
        } else if (q.id === 5 && h === 1) {
          lessList.push({ id: q.id, text: `${qName(q.id)} (1 point)` });
        }
      }
    }
  }

  moreList.sort((a,b) => a.health - b.health || a.id - b.id);

  const perfect = DATA.every(q => {
    const { opt } = picked(q.id);
    const h = Number(opt.health);
    return healthyRules[q.id] ? healthyRules[q.id](h) : false;
  });

  if (intro) intro.textContent = "Here is your feedback based on your Health scores.";
  box.hidden = false;

  const html = [];

  html.push(`<h3>You’re consuming healthy amounts of these foods:</h3>`);
  if (healthyList.length === 0) {
    html.push(`<p class="muted">None yet based on the scoring rules.</p>`);
  } else {
    html.push("<ul>" + healthyList.map(x => `<li>${escapeHtml(x.text)}</li>`).join("") + "</ul>");
  }

  if (perfect) {
    html.push(`
      <div class="advice__award">
        <strong>Perfect Diet Award</strong><br/>
        You hit the target health pattern in all 16 categories.
      </div>
    `);
  }

  html.push(`<h3>Consider eating more of these foods:</h3>`);
  if (moreList.length === 0) {
    html.push(`<p class="muted">No “eat more” flags based on your answers.</p>`);
  } else {
    html.push("<ul>" + moreList.map(x => `<li>${escapeHtml(x.text)}</li>`).join("") + "</ul>");
  }

  html.push(`<h3>And less of these foods:</h3>`);
  if (lessList.length === 0) {
    html.push(`<p class="muted">No “eat less” flags based on your answers.</p>`);
  } else {
    html.push("<ul>" + lessList.map(x => `<li>${escapeHtml(x.text)}</li>`).join("") + "</ul>");
  }

  box.innerHTML = html.join("\n");
}

render();
