/* Auto-generated from CSV.
   Health: direct from 'Health score' (0/1/2)
   Environment: direct from 'Environmental impact (New formula)' (no conversion)
*/

const DATA = [
  {
    "id": 1,
    "title": "Vegetables (fresh, frozen, or unsalted canned)",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 0.8
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 0.7
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 0,
        "env": 0.6
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 1,
        "env": 0.4
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 2,
    "title": "Beans, lentils, chickpeas, tofu",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 0.7
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 0.7
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.7
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 0.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 3,
    "title": "Fruit (fresh, frozen, or unsweetened canned).",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 0.7
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 0.6
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 0,
        "env": 0.5
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 1,
        "env": 0.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 4,
    "title": "Nuts and nut butters",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 1.5
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 1.1
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.8
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 0.2
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 5,
    "title": "Beef, pork, or lamb",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 7.9
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 2,
        "env": 5.7
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 3.6
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 3.5
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 6,
    "title": "Processed meats",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 6.5
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 1,
        "env": 4.5
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 0,
        "env": 3.4
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 3.0
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 7,
    "title": "Fish and shellfish",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 2.9
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 1,
        "env": 2.5
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 2,
        "env": 1.3
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 1.1
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 8,
    "title": "Fat-free or low-fat dairy products",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 2.4
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 2.2
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 2.1
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 1.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 9,
    "title": "Full-fat dairy products",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 2.4
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 2.2
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 2.1
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 1,
        "env": 1.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 10,
    "title": "Chicken, turkey, eggs",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 1.5
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 1.0
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.6
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 0.5
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 11,
    "title": "Restaurant meals (including pizza, fast food, and takeout)",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 0.3
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 1,
        "env": 0.2
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.2
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 0.2
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 12,
    "title": "Whole-grain bread, brown rice, whole-grain pasta, whole-grain breakfast cereal (cold/cooked)",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 0,
        "env": 0.8
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 0,
        "env": 0.6
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.5
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 2,
        "env": 0.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 2,
        "env": 0.0
      }
    ]
  },
  {
    "id": 13,
    "title": "White bread, white rice, white pasta, white potatoes",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 0.8
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 2,
        "env": 0.6
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.5
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 0.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 14,
    "title": "High-sugar drinks",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 0.5
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 1,
        "env": 0.4
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.4
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 0.3
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 15,
    "title": "Sweets and desserts",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 0.3
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 2,
        "env": 0.3
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 1,
        "env": 0.2
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 1,
        "env": 0.1
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  },
  {
    "id": 16,
    "title": "Beer, wine, liquor",
    "options": [
      {
        "key": "Less than once per week",
        "label": "Less than once per week",
        "health": 2,
        "env": 1.5
      },
      {
        "key": "Once per week",
        "label": "Once per week",
        "health": 1,
        "env": 1.4
      },
      {
        "key": "2-4 times per week",
        "label": "2-4 times per week",
        "health": 0,
        "env": 1.3
      },
      {
        "key": "Nearly daily or daily",
        "label": "Nearly daily or daily",
        "health": 0,
        "env": 1.0
      },
      {
        "key": "Twice or more times per day",
        "label": "Twice or more times per day",
        "health": 0,
        "env": 0.0
      }
    ]
  }
];

const EXPLANATIONS = {
  1: "Great, low-calorie source of vitamins, minerals, phytonutrients, and dietary fiber, with low environmental impact. Higher consumption is associated with lower rates of chronic disease. Eat plenty of veggies!",
  2: "Great sources of protein, micronutrients, and dietary fiber. Eating legumes wards off chronic diseases, and producing legumes supports soil health and has minimal adverse environmental impacts. Eat your beans!",
  3: "Great source of micronutrients and dietary fiber, with low environmental impacts. Eat plenty of fruit!",
  4: "Most nuts contain healthy oils and some protein. Choose unsalted or low-sodium products. While producing tree nuts may require a lot of water, their overall environmental impact is medium.",
  5: "Excellent source of protein, iron, and other micronutrients, but meats' saturated fat and other substances promote cardiovascular disease, premature death, and probably cancer, so enjoy only occasionally. The production of red meat has the highest environmental impact of any food because of the use of fertilizer, growing of feed grains, and cows' manure and emission of methane. Choosing pork, and especially chicken, over beef can lower your diet's environmental impact.",
  6: "Processed meats are high in sodium, saturated fat, nitrite, and carcinogenic contaminants. Frequent consumption may cause colon cancer. Processed meats, especially beef products, have a high environmental impact because of the feed required and manure and methane produced.",
  7: "Excellent sources of animal protein. Non-fried chicken saves on calories. Limit egg yolks, which are high in cholesterol, to two per week. The environmental impacts of producing poultry meat are the lowest among meat options because poultry are highly efficient converters of feed to meat.",
  8: "Seafood is rich in protein and is either low-fat or has healthful omega-3 fatty acids (e.g., salmon, trout). Hold down calories by avoiding fried seafood. Note that a serving of shrimp has as much cholesterol as eggs. The environmental impacts (based on farmed fish) is among the lowest of the animal-flesh options. Smaller fish (e.g., tilapia) are less likely to accumulate toxins than large varieties (e.g., tuna).",
  9: "Milk, yogurt and some plant-based substitutes contain protein, calcium, and several vitamins. Dairy products' modest environmental impacts are due to the fertilizer and other resources for growing feed grains and cows belching methane and excreting manure. Plant-based milks have lower impacts.",
  10: "Milk, yogurt and some plant-based substitutes contain protein, calcium, and several vitamins, but they also contain saturated fat and some cholesterol. Dairy products' modest environmental impacts are due to belching of methane, need for feed grains, and excretion of manure, but plant-based milks have lower impacts.",
  11: "Restaurant meals (especially at table-service restaurants) typically feature meat, cheese, and white flour with minor amounts of veggies and fruit. They tend to be high in calories, sodium, and saturated fat but low in dietary fiber. The environmental impacts of meals largely depend on whether they contain meat. The environmental scores are based only on the fats in average meals and are low despite the health concerns.",
  12: "Good source of fiber and modest amounts of other nutrients. Unfortunately, breads (including pizza crusts and tortillas) are a major source of sodium. The environmental impacts of producing whole grains are low.",
  13: "The refining of grains reduces their content of nutrients and dietary fiber. The environmental impacts of producing refined grains are low.",
  14: "Frequent consumption of sugar drinks promotes obesity, heart disease, type 2 diabetes, and tooth decay. Diet drinks are probably safer, but the best choices are plain water or carbonated water with or without added flavorings. The environmental impacts of producing sugar and high-fructose corn syrup are low.",
  15: "Sweets are typically high in sugar and/or saturated fat and white flour, so enjoy only occasionally. The environmental impact, based here on sugar, of producing sweets is relatively low.",
  16: "Alcohol increases risks of cancer, liver disease, auto crashes, domestic violence, and impaired careers. The environmental impact of producing alcoholic drinks is low."
};


const OPTIONS_ORDER = [
  "Less than once per week",
  "Once per week",
  "2-4 times per week",
  "Nearly daily or daily",
  "Twice or more times per day"
];

// Spreadsheet scores are 0/1/2 per question.
const MAX_PER_Q = 2;
const Q_COUNT = DATA.length;
const MAX_TOTAL = Q_COUNT * MAX_PER_Q;

const state = {
  answers: {}
};

const TITLE_OPTIONS = [
  "The FoodPrint Analyzer",
  "Health & Planet Scorecard",
  "Your Plate, Your Planet",
  "Health & Planet Scorecard",
  "The Foodprint Lab",
  "The Food Impact Meter"
];

function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}

function colorClassFromScore(score) {
  // Color is based on 0/1/2 cells in the spreadsheet.
  // If env has a decimal, round to nearest and clamp into 0..2.
  const v = clamp(Math.round(Number(score)), 0, 2);
  if (v === 0) return "badge--red";
  if (v === 1) return "badge--yellow";
  return "badge--green";
}

function pctMarker(total) {
  return clamp((total / MAX_TOTAL) * 100, 0, 100);
}

function getOption(qid, optionKey) {
  const q = DATA.find(x => x.id === qid);
  return q.options.find(o => o.key === optionKey);
}

function showTooltip(q, event) {
  const tooltip = document.getElementById("hoverTooltip");
  if (!tooltip) return;

  const cleanedTitle = q.title.replace(/\.\s*$/, "");
  const title = `${cleanedTitle}`;
  const text = EXPLANATIONS[q.id] || "";
  tooltip.dataset.qid = String(q.id);
  tooltip.innerHTML = `
    <div class="hover-tooltip__title">${escapeHtml(title)}</div>
    <div class="hover-tooltip__text">${escapeHtml(text)}</div>
  `;
  tooltip.classList.add("is-visible");
  moveTooltip(event);
}

function hideTooltip() {
  const tooltip = document.getElementById("hoverTooltip");
  if (!tooltip) return;
  tooltip.classList.remove("is-visible");
  tooltip.dataset.qid = "";
}

function moveTooltip(event) {
  const tooltip = document.getElementById("hoverTooltip");
  if (!tooltip || !event) return;

  const pad = 14;
  const hasPointer = typeof event.clientX === "number" && typeof event.clientY === "number";
  let baseX = pad;
  let baseY = pad;
  if (hasPointer) {
    baseX = event.clientX;
    baseY = event.clientY;
  } else if (event.target && event.target.getBoundingClientRect) {
    const rect = event.target.getBoundingClientRect();
    baseX = rect.right;
    baseY = rect.bottom;
  }
  const maxX = window.innerWidth - tooltip.offsetWidth - pad;
  const maxY = window.innerHeight - tooltip.offsetHeight - pad;
  const x = Math.min(baseX + pad, maxX);
  const y = Math.min(baseY + pad, maxY);
  tooltip.style.left = `${Math.max(pad, x)}px`;
  tooltip.style.top = `${Math.max(pad, y)}px`;
}

function computeTotals() {
  let health = 0;
  let env = 0;
  let answered = 0;

  for (const q of DATA) {
    const key = state.answers[q.id];
    if (!key) continue;

    answered += 1;
    const opt = getOption(q.id, key);

    health += Number(opt.health);
    env += Number(opt.env);
  }

  // Env total shown with one decimal.
  env = Math.round(env * 10) / 10;

  return { health, env, answered };
}

function render() {
  document.getElementById("questionCount").textContent = String(Q_COUNT);
  document.getElementById("maxTotalHealth").textContent = String(MAX_TOTAL);
  document.getElementById("maxTotalEnv").textContent = String(MAX_TOTAL);

  const root = document.getElementById("questionsRoot");
  root.innerHTML = "";

  for (const q of DATA) {
    const card = document.createElement("div");
    card.className = "qcard";
    card.dataset.qid = String(q.id);
    if (state.answers[q.id]) {
      card.classList.add("qcard--answered");
    }

    const top = document.createElement("div");
    top.className = "qtop";

    const textBlock = document.createElement("div");
    textBlock.className = "qtext";

    const title = document.createElement("h3");
    title.className = "qtitle";
    const cleanedTitle = q.title.replace(/\.\s*$/, "");
    const titleText = document.createElement("span");
    titleText.className = "qtitle__text";
    titleText.textContent = `Q${q.id}. ${cleanedTitle}`;

    const helpBtn = document.createElement("button");
    helpBtn.type = "button";
    helpBtn.className = "qhelp";
    helpBtn.setAttribute("aria-label", "Explain this question");
    helpBtn.textContent = "?";
    helpBtn.addEventListener("mouseenter", (event) => showTooltip(q, event));
    helpBtn.addEventListener("mousemove", moveTooltip);
    helpBtn.addEventListener("mouseleave", hideTooltip);
    helpBtn.addEventListener("focus", (event) => showTooltip(q, event));
    helpBtn.addEventListener("blur", hideTooltip);
    helpBtn.addEventListener("click", (event) => {
      event.preventDefault();
      const tooltip = document.getElementById("hoverTooltip");
      if (tooltip && tooltip.classList.contains("is-visible") && tooltip.dataset.qid === String(q.id)) {
        hideTooltip();
        return;
      }
      showTooltip(q, event);
    });

    const checkBadge = document.createElement("span");
    checkBadge.className = "qcheck";
    checkBadge.setAttribute("aria-hidden", "true");
    checkBadge.textContent = "✓";

    title.appendChild(titleText);
    title.appendChild(helpBtn);
    title.appendChild(checkBadge);

    const desc = document.createElement("p");
    desc.className = "qdesc qdesc--hidden";
    desc.textContent = EXPLANATIONS[q.id] || "";

    const scores = document.createElement("div");
    scores.className = "qscores";

    const key = state.answers[q.id];
    if (!key) {
      const b = document.createElement("div");
      b.className = "badge badge--muted";
      b.textContent = "No selection";
      scores.appendChild(b);
    } else {
      const opt = getOption(q.id, key);

      const b1 = document.createElement("div");
      b1.className = `badge ${colorClassFromScore(opt.health)}`;
      b1.innerHTML = `<span class="badge__k">Health</span> <span>${Number(opt.health)}</span>`;
      scores.appendChild(b1);

      const b2 = document.createElement("div");
      b2.className = `badge ${colorClassFromScore(opt.env)}`;
      b2.innerHTML = `<span class="badge__k">Env</span> <span>${Number(opt.env).toFixed(1)}</span>`;
      scores.appendChild(b2);
    }

    textBlock.appendChild(title);
    textBlock.appendChild(desc);
    top.appendChild(textBlock);
    top.appendChild(scores);

    const choices = document.createElement("div");
    choices.className = "choices";

    for (const optKey of OPTIONS_ORDER) {
      const optData = q.options.find(o => o.key === optKey);
      const id = `q${q.id}__${optKey.replace(/\W+/g, "_")}`;

      const choice = document.createElement("div");
      choice.className = "choice";

      const input = document.createElement("input");
      input.type = "radio";
      input.name = `q${q.id}`;
      input.id = id;
      input.value = optKey;
      input.checked = state.answers[q.id] === optKey;

      input.addEventListener("change", () => {
        state.answers[q.id] = optKey;
        updateUI();
        render();
      });

      const label = document.createElement("label");
      label.htmlFor = id;
      label.textContent = optData.label;

      choice.appendChild(input);
      choice.appendChild(label);
      choices.appendChild(choice);
    }

    card.appendChild(top);
    card.appendChild(choices);
    root.appendChild(card);
  }

  updateUI();
}

function updateUI() {
  const totals = computeTotals();

  document.getElementById("totalHealth").textContent = String(totals.health);
  document.getElementById("totalEnv").textContent = totals.env.toFixed(1);
  document.getElementById("answeredCount").textContent = String(totals.answered);

  const healthPos = `${pctMarker(totals.health)}%`;
  const envPos = `${pctMarker(totals.env)}%`;
  const healthMarker = document.getElementById("healthMarker");
  const envMarker = document.getElementById("envMarker");
  const healthMarkerBottom = document.getElementById("healthMarkerBottom");
  const envMarkerBottom = document.getElementById("envMarkerBottom");

  const showMarkers = totals.answered > 0;
  if (healthMarker) healthMarker.style.left = healthPos;
  if (envMarker) envMarker.style.left = envPos;
  if (healthMarkerBottom) healthMarkerBottom.style.left = healthPos;
  if (envMarkerBottom) envMarkerBottom.style.left = envPos;
  if (healthMarker) healthMarker.style.opacity = showMarkers ? "1" : "0";
  if (envMarker) envMarker.style.opacity = showMarkers ? "1" : "0";
  if (healthMarkerBottom) healthMarkerBottom.style.opacity = showMarkers ? "1" : "0";
  if (envMarkerBottom) envMarkerBottom.style.opacity = showMarkers ? "1" : "0";

  updateJumpButtonVisibility(totals.answered);
  updateRetakeButtonVisibility(totals.answered);
  renderAdviceIfComplete();
}

function qName(qid) {
  const q = DATA.find(x => x.id === qid);
  return q.title.replace(/\.\s*$/, "");
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function initTooltipEscClose() {
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      hideTooltip();
    }
  });
}

function initAdviceHoverTooltips() {
  const box = document.getElementById("adviceContent");
  if (!box) return;

  const findItem = (event) => {
    const target = event.target && event.target.closest
      ? event.target.closest(".advice-item")
      : null;
    return target && box.contains(target) ? target : null;
  };

  box.addEventListener("mouseover", (event) => {
    const item = findItem(event);
    if (!item) return;
    const qid = Number(item.dataset.qid);
    const q = DATA.find(x => x.id === qid);
    if (!q) return;
    showTooltip(q, event);
  });

  box.addEventListener("mousemove", (event) => {
    const item = findItem(event);
    if (!item) return;
    moveTooltip(event);
  });

  box.addEventListener("mouseout", (event) => {
    const item = findItem(event);
    if (!item) return;
    const related = event.relatedTarget;
    if (related && item.contains(related)) return;
    hideTooltip();
  });
}

function getFirstUnansweredId() {
  for (const q of DATA) {
    if (!state.answers[q.id]) return q.id;
  }
  return null;
}

function initJumpButton() {
  const button = document.getElementById("jumpNextUnanswered");
  if (!button) return;

  button.addEventListener("click", () => {
    const nextId = getFirstUnansweredId();
    if (!nextId) return;
    const card = document.querySelector(`.qcard[data-qid="${nextId}"]`);
    if (card && card.scrollIntoView) {
      card.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  });
}

function updateJumpButtonVisibility(answeredCount) {
  const button = document.getElementById("jumpNextUnanswered");
  if (!button) return;
  const hasUnanswered = answeredCount < Q_COUNT;
  button.hidden = answeredCount === 0 || !hasUnanswered;
  button.disabled = !hasUnanswered;
}

function updateRetakeButtonVisibility(answeredCount) {
  const button = document.getElementById("retakeExperiment");
  if (!button) return;
  button.hidden = answeredCount !== Q_COUNT;
}

function initRetakeButton() {
  const button = document.getElementById("retakeExperiment");
  if (!button) return;

  button.addEventListener("click", () => {
    state.answers = {};
    updateUI();
    render();
    const root = document.getElementById("questionsRoot");
    if (root && root.scrollIntoView) {
      root.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  });
}

function getAdviceIconSvg(qid) {
  const icons = {
    1: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M5 15c4-7 10-8 14-8-1 6-4 11-9 13-3 1-6-1-5-5z"/>
      <path d="M8 14c2 1 4 3 4 6"/>
    </svg>`,
    2: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M5 16c2-6 6-10 11-10 2 0 3 2 2 4-2 5-7 8-12 10"/>
      <circle cx="9" cy="12" r="1"/>
      <circle cx="12" cy="10" r="1"/>
      <circle cx="15" cy="9" r="1"/>
    </svg>`,
    3: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 7c-3 0-5 2-5 5 0 4 3 7 5 7s5-3 5-7c0-3-2-5-5-5z"/>
      <path d="M12 7V5"/>
      <path d="M12 5c2-2 4-2 5 0"/>
    </svg>`,
    4: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 4c3 0 5 2 5 5 0 2-1 4-1 6 0 3-2 5-4 5s-4-2-4-5c0-2-1-4-1-6 0-3 2-5 5-5z"/>
      <path d="M12 6c-1 2-1 4 0 6"/>
    </svg>`,
    5: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M7 10c0-3 2-5 5-5s5 2 5 5v6c0 2-2 4-5 4s-5-2-5-4z"/>
      <path d="M7 10l-3-2"/>
      <path d="M17 10l3-2"/>
      <circle cx="10" cy="14" r="1"/>
      <circle cx="14" cy="14" r="1"/>
    </svg>`,
    6: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M5 10c0-2 2-4 4-4h6c2 0 4 2 4 4v4c0 2-2 4-4 4H9c-2 0-4-2-4-4z"/>
      <path d="M7 8l-2-2"/>
      <path d="M17 8l2-2"/>
    </svg>`,
    7: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M3 12c3-4 9-4 12 0-3 4-9 4-12 0z"/>
      <path d="M15 12l5-3v6z"/>
      <circle cx="9" cy="12" r="1"/>
    </svg>`,
    8: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M7 4h8l2 3v13H7z"/>
      <path d="M7 7h10"/>
      <path d="M9 4v3"/>
    </svg>`,
    9: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M4 8l16 4-2 8H4z"/>
      <circle cx="10" cy="14" r="1"/>
      <circle cx="14" cy="16" r="1"/>
    </svg>`,
    10: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 4c4 0 6 6 6 9a6 6 0 1 1-12 0c0-3 2-9 6-9z"/>
    </svg>`,
    11: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M5 14a7 7 0 0 1 14 0"/>
      <path d="M4 16h16"/>
      <path d="M12 7V5"/>
    </svg>`,
    12: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 4v16"/>
      <path d="M12 7l-3-2"/>
      <path d="M12 9l3-2"/>
      <path d="M12 11l-3-2"/>
      <path d="M12 13l3-2"/>
      <path d="M12 15l-3-2"/>
    </svg>`,
    13: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M6 8c0-2 2-4 6-4s6 2 6 4v10H6z"/>
    </svg>`,
    14: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M8 6h8l-1 14H9z"/>
      <path d="M14 6l2-3"/>
    </svg>`,
    15: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M7 11c0-3 2-5 5-5s5 2 5 5"/>
      <path d="M6 12h12l-1 7H7z"/>
      <path d="M9 11c1-1 2-1 3 0 1-1 2-1 3 0"/>
    </svg>`,
    16: `<svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M8 4h8c0 4-3 7-4 7s-4-3-4-7z"/>
      <path d="M12 11v7"/>
      <path d="M9 19h6"/>
    </svg>`
  };

  return icons[qid] || "";
}

function renderAdviceIfComplete() {
  const totals = computeTotals();
  const intro = document.getElementById("adviceIntro");
  const box = document.getElementById("adviceContent");

  if (totals.answered !== Q_COUNT) {
    if (intro) intro.textContent = "";
    box.hidden = true;
    box.innerHTML = "";
    return;
  }

  const picked = (qid) => {
    const key = state.answers[qid];
    const opt = getOption(qid, key);
    return { key, opt };
  };

  const healthyRules = {
    1: (h) => h === 2,
    2: (h) => h === 1 || h === 2,
    3: (h) => h === 2,
    4: (h) => h === 2,
    5: (h) => h === 2,
    6: (h) => h === 2,
    7: (h) => h === 2,
    8: (h) => h === 2,
    9: (h) => h === 1,
    10: (h) => h === 2,
    11: (h) => h === 1,
    12: (h) => h === 2,
    13: (h) => h === 2,
    14: (h) => h === 2,
    15: (h) => h === 2,
    16: (h) => h === 2
  };

  const moreFoods = [1,2,3,4,7,8,10,12];
  const lessFoods = [5,6,9,11,13,14,15,16];

  const healthyList = [];
  const moreList = [];
  const lessList = [];

  for (const q of DATA) {
    const { key, opt } = picked(q.id);
    const h = Number(opt.health);

    if (healthyRules[q.id] && healthyRules[q.id](h)) {
      healthyList.push({
        id: q.id,
        text: qName(q.id)
      });
    }

    if (moreFoods.includes(q.id) && (h === 0 || h === 1)) {
      moreList.push({
        id: q.id,
        health: h,
        text: qName(q.id)
      });
    }

    if (lessFoods.includes(q.id)) {
      if (q.id === 6 && h === 0) {
        lessList.push({ id: q.id, text: qName(q.id) });
      } else if (q.id === 9) {
        if (key === "Nearly daily or daily" || key === "Twice or more times per day") {
          lessList.push({ id: q.id, text: qName(q.id) });
        }
      } else {
        if (h === 0) {
          lessList.push({ id: q.id, text: qName(q.id) });
        } else if (q.id === 5 && h === 1) {
          lessList.push({ id: q.id, text: qName(q.id) });
        }
      }
    }
  }

  moreList.sort((a,b) => a.health - b.health || a.id - b.id);

  const perfect = DATA.every(q => {
    const { opt } = picked(q.id);
    const h = Number(opt.health);
    return healthyRules[q.id] ? healthyRules[q.id](h) : false;
  });

  if (intro) intro.textContent = "Based on your answers, here’s how your diet compares to recommended patterns.";
  box.hidden = false;

  const html = [];
  const renderAdviceList = (items) => {
    return "<ul>" + items.map(item => {
      return `
        <li class="advice-item" data-qid="${item.id}">
          <span class="advice-item__icon" aria-hidden="true">${getAdviceIconSvg(item.id)}</span>
          <span class="advice-item__text">${escapeHtml(item.text)}</span>
        </li>
      `;
    }).join("") + "</ul>";
  };

  html.push(`<h3>Your answers suggest healthy intake of these foods:</h3>`);
  if (healthyList.length === 0) {
    html.push(`<p class="muted">None yet based on the scoring rules.</p>`);
  } else {
    html.push(renderAdviceList(healthyList));
  }

  if (perfect) {
    html.push(`
      <div class="advice__award">
        <strong>Perfect Diet Award</strong><br/>
        You hit the target health pattern in all 16 categories.
      </div>
    `);
  }

  html.push(`<h3>Consider eating more of these foods:</h3>`);
  if (moreList.length === 0) {
    html.push(`<p class="muted">No “eat more” flags based on your answers.</p>`);
  } else {
    html.push(renderAdviceList(moreList));
  }

  html.push(`<h3>And less of these foods:</h3>`);
  if (lessList.length === 0) {
    html.push(`<p class="muted">No “eat less” flags based on your answers.</p>`);
  } else {
    html.push(renderAdviceList(lessList));
  }

  box.innerHTML = html.join("\n");
}

render();

function initTitleSwitcher() {
  const button = document.getElementById("titleSwitcher");
  const arcText = document.getElementById("titleArcText");
  const titleText = document.getElementById("titleText");
  const srText = document.getElementById("titleSrOnly");
  if (!button || !arcText || !titleText || !srText) return;

  const applyTitle = (value) => {
    arcText.textContent = value;
    titleText.textContent = value;
    srText.textContent = value;
  };

  applyTitle(button.value || TITLE_OPTIONS[0]);
  button.addEventListener("change", (event) => {
    applyTitle(event.target.value);
  });
}

initTitleSwitcher();
initTooltipEscClose();
initAdviceHoverTooltips();
initJumpButton();
initRetakeButton();
